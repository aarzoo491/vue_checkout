<!doctype html>
<html lang="">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite App</title>
    <script async type="text/javascript">
        window.visiopt_code = window.visiopt_code ||
            (function () {
                var visi_wid = 1040;
                var visi_flicker_time = 4000;
                var visi_flicker_element = "html";
                var d = document;
                var c = false;
                var lastPath = location.pathname;
                var visi_fn = {
                    begin: function () {
                        if (d.getElementById("visi_flicker")) return;
                        var css = visi_flicker_element + "{opacity:0!important;background:none!important;}";
                        var st = d.createElement("style");
                        st.id = "visi_flicker";
                        st.type = "text/css";
                        if (st.styleSheet) st.styleSheet.cssText = css;
                        else st.appendChild(d.createTextNode(css));
                        d.head.appendChild(st);
                    },
                    complete: function () {
                        c = true;
                        var f = d.getElementById("visi_flicker");
                        if (f) f.remove();
                    },
                    completed: function () {
                        return c;
                    },
                    pack: function (src) {
                        waitForAppHome(function () {
                            if (window.__visi_vt_loaded__) {
                                runVisiForCurrentPage();
                                return;
                            }
                            window.__visi_vt_loaded__ = true;
                            var s = d.createElement("script");
                            s.src = src;
                            s.type = "text/javascript";
                            s.async = true;
                            s.onerror = function () {
                                visi_fn.complete();
                            };
                            d.head.appendChild(s);
                        });
                    },
                    init: function () {
                        visi_fn.begin();
                        setTimeout(function () {
                            visi_fn.complete();
                        }, visi_flicker_time);

                        visi_fn.pack("https://optimize.visioptdev.com/vt." + visi_wid + ".js");
                        return true;
                    }
                };
                window.visiopt_code_status = visi_fn.init();
                function waitForAppHome(done) {
                    let tries = 0;
                    function check() {
                        tries++;
                        if (document.querySelector("#app")) {
                            requestAnimationFrame(() => {
                                requestAnimationFrame(() => {
                                    done();
                                });
                            });
                            return;
                        }
                        if (tries < 200) {
                            return setTimeout(check, 20);
                        }
                        done();
                    }
                    check();
                }
                function watchUrlChanges(callback) {
                    setInterval(function () {
                        var current = location.pathname;
                        if (current !== lastPath) {
                            lastPath = current;
                            console.log("[VISI] Route changed â†’", current);
                            callback();
                        }
                    }, 60);
                }
                function runVisiForCurrentPage() {
                    if (typeof VisiPageMatcher === "undefined") {
                        console.warn("VisiPageMatcher not loaded yet");
                        return;
                    }
                    var pageJson = VisiPageMatcher.getPageIdByURL(visiopt_settings.pages, location.href);
                    if (!pageJson) {
                        console.log("Page json not found");
                        return;
                    }
                    VisioptConfig.set(pageJson);
                    if (typeof resetVisioptBeforeRouteChange !== "undefined") {
                        if (!window.__visi_resetter__) {
                            window.__visi_resetter__ = new resetVisioptBeforeRouteChange();
                        }
                        window.__visi_resetter__.init();
                    }
                    if (typeof VisiOptSDK === "undefined") {
                        console.warn("VisiOptSDK missing");
                        return;
                    }
                    // waitForAppHome(function () {
                    //     window.VisiBoot();
                    // });
                    window.VisiBoot();
                }
                watchUrlChanges(function () {
                    runVisiForCurrentPage();
                });
                return visi_fn;
            })();
    </script>
</head>

<body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
</body>

</html>
